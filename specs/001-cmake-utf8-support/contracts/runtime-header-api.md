# Runtime Header API Contract: UTF-8 Console

**Generated**: 2026-02-27  
**Feature**: 001-cmake-utf8-support  
**Type**: C++ Public API

---

## Overview

This document defines the C++ API contract for the UTF-8 console initialization header. This is the runtime interface that application developers use to enable UTF-8 console output.

---

## 1. Header Information

**Header Name**: `<jsav/utf8_console.hpp>`

**Generation**: This header is generated by CMake from `configured_files/include/jsav/utf8_console.hpp.in`

**Include Guard**: `JSAV_UTF8_CONSOLE_HPP`

**Dependencies**:

```cpp
#include <cstdlib>      // std::exit, EXIT_FAILURE
#ifdef _WIN32
    #include <windows.h>    // SetConsoleOutputCP, CP_UTF8
#endif
#include <fmt/core.h>   // fmt::print (for error messages)
```

---

## 2. Namespace

**Namespace**: `jsav::utf8`

**Purpose**: Isolate UTF-8 console functionality from application code

**Visibility**: All functions are `inline` for header-only usage

---

## 3. Public API

### 3.1 `init_console()`

**Signature**:

```cpp
namespace jsav::utf8 {
    inline void init_console();
}
```

**Parameters**: None

**Return Value**: None (void)

**Behavior**:

#### On Windows (`_WIN32` defined):

1. Calls `SetConsoleOutputCP(CP_UTF8)` to set console output code page to UTF-8
2. If call succeeds (returns non-zero): function returns normally
3. If call fails (returns 0):
   - Prints error message to stderr via `fmt::print`
   - Calls `std::exit(EXIT_FAILURE)` to terminate application

**Error Message** (on failure):

```test
ERROR: UTF-8 console initialization failed.
       Terminal does not support UTF-8 output.
       Ensure you are using Windows Terminal or a compatible terminal emulator.
```

#### On Linux/macOS (neither `_WIN32` nor `_WIN64` defined):

1. Function body is empty (no-op)
2. Returns immediately
3. No side effects

**Rationale for No-op**:

- Modern Linux/macOS distributions use UTF-8 as default locale
- No initialization is required for UTF-8 console output
- Non-UTF-8 locales are unsupported (developer must configure at OS level)

---

## 4. Usage Contract

### 4.1 Required Usage Pattern

**Location**: Must be called at the beginning of `main()` function

**Condition**: Must be called **unconditionally** (not inside `#ifdef` or runtime checks)

**Example**:

```cpp
#include <jsav/utf8_console.hpp>
#include <fmt/core.h>

int main() {
    jsav::utf8::init_console();  // ‚Üê Call unconditionally
    
    // Now safe to output UTF-8
    fmt::print("Hello, ‰∏ñÁïåÔºÅüåç\n");
    
    return 0;
}
```

### 4.2 Prohibited Usage Patterns

**‚ùå Don't wrap in preprocessor conditionals**:

```cpp
// WRONG - defeats the purpose of fail-fast
#ifdef _WIN32
    jsav::utf8::init_console();
#endif
```

**‚ùå Don't call conditionally at runtime**:

```cpp
// WRONG - may forget to call in some code paths
if (some_condition) {
    jsav::utf8::init_console();
}
```

**‚ùå Don't call after UTF-8 output**:

```cpp
// WRONG - too late, UTF-8 already corrupted
fmt::print("Hello, ‰∏ñÁïå\n");
jsav::utf8::init_console();
```

---

## 5. Error Handling Contract

### 5.1 Fail-Fast Behavior

**Philosophy**: Fail immediately with clear error message rather than silently corrupting output

**Trigger**: `SetConsoleOutputCP(CP_UTF8)` returns 0 (failure)

**Actions**:

1. Error message printed to stderr (not stdout)
2. `std::exit(EXIT_FAILURE)` called immediately
3. Application terminates without executing further code

**Rationale**:

- Silent failure would result in mojibake/corrupted output
- Early failure helps developers identify terminal compatibility issues
- Clear error message provides actionable guidance

### 5.2 No Exception Safety

**Contract**: Function does NOT throw C++ exceptions

**Reason**:

- Uses `std::exit()` for failure, not exceptions
- May be called before C++ runtime is fully initialized
- Exception handling may not be enabled in all builds

---

## 6. Thread Safety

**Contract**: Function is **NOT** thread-safe

**Requirements**:

- Must be called from main thread
- Must be called before any other threads are created
- Must be called before any console output occurs

**Rationale**:

- `SetConsoleOutputCP` affects process-wide console state
- Concurrent calls from multiple threads would cause race conditions
- Calling once from main thread ensures all threads inherit UTF-8 setting

---

## 7. Lifetime and Scope

**Scope**: Process-wide

**Lifetime**: From call until process termination

**Inheritance**: All child processes inherit UTF-8 code page setting

**Reset**: No API provided to reset console code page (intentional)

**Rationale**:

- UTF-8 should be set once at application start
- Resetting would risk corrupting subsequent output
- Applications needing different code pages should use separate console handles

---

## 8. Platform-Specific Behavior

### 8.1 Windows

| Aspect                    | Behavior                                             |
|---------------------------|------------------------------------------------------|
| **API Used**              | `SetConsoleOutputCP(CP_UTF8)`                        |
| **Code Page**             | 65001 (UTF-8)                                        |
| **Failure Mode**          | Exit with error message                              |
| **Terminal Requirements** | Windows Terminal, or cmd.exe with UTF-8 font         |
| **Minimum OS Version**    | Windows 10 1607+ (for full UTF-8 support)            |
| **Legacy Systems**        | Windows 7/8: May work with limited character support |

### 8.2 Linux

| Aspect                    | Behavior                                        |
|---------------------------|-------------------------------------------------|
| **API Used**              | None (no-op)                                    |
| **Locale**                | Assumed UTF-8 (default on modern distributions) |
| **Failure Mode**          | N/A                                             |
| **Terminal Requirements** | Any terminal with UTF-8 locale                  |
| **Non-UTF-8 Locales**     | Unsupported (developer must configure OS)       |

### 8.3 macOS

| Aspect                    | Behavior                                      |
|---------------------------|-----------------------------------------------|
| **API Used**              | None (no-op)                                  |
| **Locale**                | Assumed UTF-8 (default on all macOS versions) |
| **Failure Mode**          | N/A                                           |
| **Terminal Requirements** | Terminal.app, iTerm2, or any UTF-8 terminal   |

---

## 9. Testing Contract

### 9.1 Unit Test Requirements

Tests MUST verify:

1. **Windows**:
   - `SetConsoleOutputCP` is called with `CP_UTF8`
   - Function exits on failure
   - Error message is printed to stderr

2. **Linux/macOS**:
   - Function returns immediately
   - No side effects
   - No console API calls

3. **All Platforms**:
   - Function can be called multiple times (idempotent)
   - No memory leaks
   - No exceptions thrown

### 9.2 Integration Test Requirements

Tests MUST verify:

1. UTF-8 string literals are preserved in compiled binary
2. Console output displays UTF-8 correctly after initialization
3. Application fails fast on incompatible terminal (Windows only)

---

## 10. Version Compatibility

| Header Version | jsav Version | Minimum Compiler | fmt Version |
|----------------|--------------|------------------|-------------|
| 1.0            | 0.0.2+       | C++23            | 12.1.0      |

**Backward Compatibility**:

- Header is forward-compatible within 0.x.x series
- Breaking changes require major version bump
- Deprecation warnings issued one minor version before removal

---

## 11. Common Issues and Solutions

### Issue 1: "UTF-8 console initialization failed"

**Cause**: Terminal doesn't support UTF-8 output

**Solution**:

- Use Windows Terminal (recommended)
- Update cmd.exe to use UTF-8 font (Lucida Console or Consolas)
- Check terminal emulator documentation for UTF-8 support

### Issue 2: UTF-8 still displays incorrectly after initialization

**Cause**: Font doesn't support required Unicode ranges

**Solution**:

- Install fonts with broad Unicode coverage (e.g., Segoe UI Emoji, Noto fonts)
- Check font settings in terminal emulator

### Issue 3: Application works on development machine but fails in CI

**Cause**: CI environment uses non-interactive terminal

**Solution**:

- Configure CI to use UTF-8-compatible terminal
- On Windows CI, ensure Windows Terminal is available
- Consider skipping UTF-8 tests in non-interactive environments

---

## 12. Security Considerations

**No User Input**: Function does not process user input

**No Memory Allocation**: Function does not allocate memory

**No File I/O**: Function does not read/write files

**Attack Surface**: Minimal - only calls Win32 API on Windows

**Recommendation**: No special security considerations required

---

## 13. Performance Characteristics

| Metric              | Windows                          | Linux/macOS               |
|---------------------|----------------------------------|---------------------------|
| **Call Overhead**   | ~1ms (Win32 API call)            | <1Œºs (empty inline)       |
| **Memory Overhead** | 0 bytes                          | 0 bytes                   |
| **Code Size**       | ~200 bytes (with error handling) | ~5 bytes (empty function) |

**Optimization**: Function is `inline` - compiler may eliminate entirely on Linux/macOS

---

## 14. Deprecation Policy

**Contract Stability**: This API is stable and will not change without major version bump

**Deprecation Process**:

1. Deprecated function marked with `[[deprecated("message")]]`
2. Deprecation warning issued for one minor version
3. Function removed in next major version

**Example**:

```cpp
[[deprecated("Use init_console() instead - no return value")]]
inline bool init_console_with_result();
```
